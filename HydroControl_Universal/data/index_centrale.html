<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HydroControl-GE - Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; border-bottom: 2px solid #007aff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f8f8; }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .modal { /* Styles pour la modale d'assignation */ }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard de Supervision HydroControl-GE</h1>
        <table>
            <thead>
                <tr>
                    <th>ID du Nœud</th>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>État Pompe</th>
                    <th>RSSI (dBm)</th>
                    <th>Dernier Contact</th>
                    <th>Assigné à</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="node-table-body">
                <!-- Les données des nœuds seront injectées ici par JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modale pour l'assignation et le renommage -->

    <script>
        function initSSE() {
            if (!!window.EventSource) {
                var source = new EventSource('/events');

                source.addEventListener('open', function(e) {
                    console.log("SSE Connection opened.");
                }, false);

                source.addEventListener('error', function(e) {
                    if (e.target.readyState != EventSource.OPEN) {
                        console.log("SSE Connection closed. Falling back to fetch.");
                        // Fallback to polling if SSE fails
                        setTimeout(fetchStatus, 1000);
                    }
                }, false);

                source.addEventListener('update', function(e) {
                    console.log("Received update:", e.data);
                    var data = JSON.parse(e.data);
                    updateTable(data.nodes);
                }, false);
            }
        }

        function updateTable(nodes) {
            const tableBody = document.getElementById('node-table-body');
            tableBody.innerHTML = ''; // Clear table
            nodes.forEach(node => {
                let row = `<tr>
                    <td>${node.id}</td>
                    <td>${node.name || 'N/A'}</td>
                    <td>${node.type == 2 ? 'AquaReservPro' : (node.type == 3 ? 'WellguardPro' : 'Unknown')}</td>
                    <td>${node.status}</td>
                    <td>${node.pumpState ? 'ON' : 'OFF'}</td>
                    <td>${node.rssi}</td>
                    <td>${new Date(node.lastSeen).toLocaleString()}</td>
                    <td>${node.assignedTo || 'N/A'}</td>
                    <td><button onclick="renameNode('${node.id}')">Renommer</button> ${node.type == 2 ? `<button onclick="assignWell('${node.id}')">Assigner</button>` : ''}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function fetchStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateTable(data.nodes);
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function renameNode(nodeId) {
            let newName = prompt("Entrez le nouveau nom pour le nœud " + nodeId + ":");
            if (newName) {
                fetch('/api/set-name', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: nodeId, name: newName})
                });
            }
        }

        function assignWell(reservoirId) {
            let wellId = prompt("Entrez l'ID du puits à assigner à " + reservoirId + ":");
            if (wellId) {
                fetch('/api/assign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({reservoirId: reservoirId, wellId: wellId})
                });
            }
        }

        document.addEventListener('DOMContentLoaded', initSSE);
    </script>
</body>
</html>
